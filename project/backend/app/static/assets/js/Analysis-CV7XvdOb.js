import{u as K,e as u,m as L,H as q,l as re,c as b,o as g,a as o,f as Z,w as N,h as B,E as U,t as k,v as ie,I as le,F as de,r as ue,n as G,j as ce,b as R,p as ve}from"./index-hxhUZtIB.js";import{_ as W}from"./Logo-Dc4xVNqq.js";import{a as me}from"./index-BtuGy7By.js";import{u as pe}from"./Main-BxS9VA3Z.js";const fe={class:"video-panel"},ye={class:"video-wrapper"},ge={class:"options-panel"},he={key:0},_e={key:0,class:"skeleton-controls"},be={class:"video-frame"},ke=["src"],xe={key:0,class:"loading-overlay"},$e={class:"loading-text"},Fe={key:0,class:"debug-panel"},we={class:"video-controls"},Se=["max","disabled"],Te={class:"time-display"},Ae={class:"navigation-buttons"},Pe=["disabled"],Ve=["disabled"],Ce={__name:"FramePanel",props:{videoId:{type:String,required:!0}},setup(n){const e=n,i=K(),F=u([]),d=u([]),t=u([]),y=u(!0),r=u(0),f=u(0),O=u(null),M=u(!1),c=u(!1),h=u(!1),x=u(!0),V=u(!1),C=u(!1),X=u(!1);let S=u(null);const D=L(()=>t.value.length),j=L(()=>f.value+1),Q=L(()=>t.value[f.value]||""),ee=L(()=>{var a,m,p;if(!((m=(a=S.value)==null?void 0:a.instance_info)!=null&&m.length))return"骨骼数据加载中或格式异常";const l=S.value.instance_info.find(v=>v.frame_id===j.value);if(!((p=l==null?void 0:l.instances)!=null&&p.length))return`帧 ${j.value} 无检测实例`;let s=`=== 帧 ${j.value} ===
`;return l.instances.forEach((v,A)=>{var _;if(s+=`实例 ${A+1}:
`,Array.isArray(v.bbox)&&v.bbox.length>=4){const[H,$,w,P]=v.bbox;s+=`边界框: x1=${H.toFixed(1)}, y1=${$.toFixed(1)}, x2=${w.toFixed(1)}, y2=${P.toFixed(1)}
`}if(Array.isArray(v.keypoints)){const H=((_=S.value.meta_info)==null?void 0:_.keypoint_id2name)||{};s+=`关键点:
`,v.keypoints.forEach(($,w)=>{var E,T,I,J;const P=H[w]||`点${w}`,z=((T=(E=v.keypoint_scores)==null?void 0:E[w])==null?void 0:T.toFixed(2))??"N/A";s+=`  ${P}: [${((I=$[0])==null?void 0:I.toFixed(1))??"NaN"}, ${((J=$[1])==null?void 0:J.toFixed(1))??"NaN"}], 置信度: ${z}
`})}s+=`
`}),s}),se=()=>{var l;!h.value||!((l=S.value)!=null&&l.instance_info)||le(()=>{var m,p;const s=document.querySelector(".video-frame img"),a=O.value;if(a.innerHTML="",!(!s||!a))try{const v=s.clientWidth/s.naturalWidth,A=s.clientHeight/s.naturalHeight,_=(m=S.value.instance_info)==null?void 0:m.find($=>$.frame_id===j.value);if(!(_!=null&&_.instances))return;const H=((p=S.value.meta_info)==null?void 0:p.keypoint_id2name)||{};_.instances.forEach($=>{if(V.value&&Array.isArray($.bbox)&&$.bbox.length>=4){const[w,P,z,E]=$.bbox,T=document.createElement("div");T.className="bbox",Object.assign(T.style,{left:`${w*v}px`,top:`${P*A}px`,width:`${(z-w)*v}px`,height:`${(E-P)*A}px`,display:V.value?"block":"none"}),a.appendChild(T)}x.value&&Array.isArray($.keypoints)&&$.keypoints.forEach((w,P)=>{if(w.length<2)return;const[z,E]=w,T=document.createElement("div");if(T.className="keypoint",Object.assign(T.style,{left:`${z*v}px`,top:`${E*A}px`,display:x.value?"block":"none"}),a.appendChild(T),X.value){const I=document.createElement("div");I.className="keypoint-label",I.textContent=H[P]||`点${P}`,Object.assign(I.style,{left:`${z*v}px`,top:`${E*A}px`,transform:"translate(-50%, -100%)"}),a.appendChild(I)}})})}catch(v){console.error("渲染错误:",v)}})},oe=()=>f.value>0&&f.value--,te=()=>f.value<D.value-1&&f.value++;q(c,async l=>{l&&d.value.length===0&&(d.value=await Y(e.videoId,!0)),t.value=l?d.value:F.value}),q(h,l=>{l&&!S.value&&ne(e.videoId)}),re(async()=>{e.videoId&&(F.value=await Y(e.videoId),t.value=F.value,y.value=!1)}),q(()=>e.videoId,async l=>{l&&(F.value=await Y(l),t.value=F.value,d.value=[],S.value=null)});const Y=async(l,s=!1)=>{const a=s?`/api/pose-frames/${l}`:`/api/frames-batch/${l}`;try{const m=await fetch(a,{headers:{Authorization:`Bearer ${i.token}`}}),{data:p}=await m.json();return(p==null?void 0:p.frames)||[]}catch(m){return console.error("加载失败:",m),[]}};async function ne(l){var s,a;try{const m=await fetch(`/api/pose-data/${l}`,{headers:{Authorization:`Bearer ${i.token}`}});if(!m.ok)throw new Error(`HTTP错误 ${m.status}`);const p=await m.json();if(!p.success)throw new Error(p.message||"未知错误");const v={meta_info:{...p.data.meta_info,skeleton_links:((s=p.data.meta_info)==null?void 0:s.skeleton_links)||[],keypoint_colors:Array.isArray((a=p.data.meta_info)==null?void 0:a.keypoint_colors)?p.data.meta_info.keypoint_colors:[]},instance_info:(p.data.instance_info||[]).map(A=>({frame_id:Number(A.frame_id)||0,instances:(A.instances||[]).map(_=>({bbox:Array.isArray(_.bbox)?_.bbox.flat():[],keypoints:ae(_.keypoints),keypoint_scores:Array.isArray(_.keypoint_scores)?_.keypoint_scores:[]}))}))};return S.value=v,v}catch(m){throw console.error("骨骼数据加载失败:",m),S.value={error:m.message},m}}function ae(l){return Array.isArray(l)?l.map(s=>Array.isArray(s)?s.map(Number):[]):[]}return(l,s)=>(g(),b("div",fe,[o("div",ye,[s[13]||(s[13]=o("h2",null,"视频帧分析",-1)),o("div",ge,[o("label",null,[N(o("input",{type:"checkbox","onUpdate:modelValue":s[0]||(s[0]=a=>c.value=a)},null,512),[[U,c.value]]),s[7]||(s[7]=B(" 添加骨骼点检测 "))]),o("label",null,[N(o("input",{type:"checkbox","onUpdate:modelValue":s[1]||(s[1]=a=>h.value=a)},null,512),[[U,h.value]]),s[8]||(s[8]=B(" 添加坐标绘制 ")),M.value?(g(),b("span",he,"(加载中...)")):Z("",!0)]),h.value?(g(),b("div",_e,[o("label",null,[N(o("input",{type:"checkbox","onUpdate:modelValue":s[2]||(s[2]=a=>x.value=a)},null,512),[[U,x.value]]),s[9]||(s[9]=B(" 显示骨骼点 "))]),o("label",null,[N(o("input",{type:"checkbox","onUpdate:modelValue":s[3]||(s[3]=a=>V.value=a)},null,512),[[U,V.value]]),s[10]||(s[10]=B(" 显示边界框 "))]),o("label",null,[N(o("input",{type:"checkbox","onUpdate:modelValue":s[4]||(s[4]=a=>C.value=a)},null,512),[[U,C.value]]),s[11]||(s[11]=B(" 显示调试信息 "))]),o("label",null,[N(o("input",{type:"checkbox","onUpdate:modelValue":s[5]||(s[5]=a=>X.value=a)},null,512),[[U,X.value]]),s[12]||(s[12]=B(" 显示关键点标签 "))])])):Z("",!0)]),o("div",be,[o("img",{src:Q.value,alt:"",onLoad:se},null,40,ke),o("div",{ref_key:"skeletonOverlay",ref:O,class:"skeleton-overlay"},null,512),y.value?(g(),b("div",xe,[o("div",$e,"加载中... "+k(r.value)+"/"+k(D.value),1)])):Z("",!0)]),C.value?(g(),b("div",Fe,[o("pre",null,k(ee.value),1)])):Z("",!0),o("div",we,[N(o("input",{type:"range","onUpdate:modelValue":s[6]||(s[6]=a=>f.value=a),min:0,max:D.value-1,step:"1",disabled:y.value},null,8,Se),[[ie,f.value,void 0,{number:!0}]]),o("div",Te,k(j.value)+" / "+k(D.value),1)]),o("div",Ae,[o("button",{onClick:oe,disabled:f.value===0,class:"sync-button"},"上一帧",8,Pe),o("button",{onClick:te,disabled:f.value===D.value-1,class:"sync-button"},"下一帧",8,Ve)])])]))}},Ee={class:"analysis-tabs"},Ie={class:"tab-nav"},Ne=["onClick"],Ze={__name:"AnalysisTabs",setup(n){const e=u("分析报告"),i=u(["分析报告","动作分析","可视化图表"]);return(F,d)=>(g(),b("div",Ee,[o("div",Ie,[(g(!0),b(de,null,ue(i.value,t=>(g(),b("button",{key:t,class:G({active:e.value===t}),onClick:y=>e.value=t},k(t),11,Ne))),128))]),d[0]||(d[0]=o("div",{class:"tab-content"},null,-1))]))}},ze=W(Ze,[["__scopeId","data-v-8bda7552"]]),Be={props:{type:String,progress:Number,currentTime:Number,duration:Number,isZoomed:Boolean},methods:{formatTime(n){const e=new Date(0);return e.setSeconds(n||0),e.toISOString().slice(11,19)}}},Ue={class:"video-controls"},Le=["value"],qe={class:"time-display"};function De(n,e,i,F,d,t){var y;return g(),b("div",Ue,[o("button",{onClick:e[0]||(e[0]=r=>n.$emit("toggle-play"))},k((y=n.$parent.$refs[`${i.type}Video`])!=null&&y.paused?"▶":"⏸"),1),o("input",{type:"range",class:"progress-bar",value:i.progress,onInput:e[1]||(e[1]=r=>n.$emit("seek",r.target.value)),min:"0",max:"100",step:"0.1"},null,40,Le),o("span",qe,k(t.formatTime(i.currentTime))+" / "+k(t.formatTime(i.duration)),1),o("button",{onClick:e[2]||(e[2]=r=>n.$emit("toggle-zoom"))},k(i.isZoomed?"✕":"⛶"),1)])}const je=W(Be,[["render",De],["__scopeId","data-v-092d2f97"]]),He={components:{VideoControls:je},props:{originalSrc:String,processedSrc:String},data(){return{isSyncing:!1,progress:{original:0,processed:0},currentTime:{original:0,processed:0},duration:{original:0,processed:0},isZoomed:{original:!1,processed:!1}}},mounted(){document.addEventListener("fullscreenchange",this.handleFullscreenChange)},beforeDestroy(){document.removeEventListener("fullscreenchange",this.handleFullscreenChange)},methods:{togglePlay(n){const e=this.$refs[`${n}Video`];e.paused?e.play():e.pause()},updateProgress(n,e){const i=n.target;this.currentTime[e]=i.currentTime,this.duration[e]=i.duration,this.progress[e]=i.currentTime/i.duration*100||0,this.isSyncing&&e==="original"&&(this.$refs.processedVideo.currentTime=i.currentTime)},handleSeek(n,e){const i=this.$refs[`${e}Video`];i.currentTime=n*i.duration/100},toggleSync(){this.isSyncing=!this.isSyncing,this.isSyncing&&this.syncVideos()},async syncVideos(){await Promise.all([this.$refs.originalVideo.play(),this.$refs.processedVideo.play()])},handlePlay(){this.isSyncing&&this.syncVideos()},handlePause(){this.isSyncing&&(this.$refs.originalVideo.pause(),this.$refs.processedVideo.pause())},async toggleZoom(n){const e=this.$refs[`${n}Panel`];this.isZoomed[n]?(await this.exitFullscreen(),this.isZoomed={...this.isZoomed,[n]:!1}):(await this.enterFullscreen(e),this.isZoomed={...this.isZoomed,[n]:!0})},async enterFullscreen(n){if(n.requestFullscreen)return n.requestFullscreen();if(n.webkitRequestFullscreen)return n.webkitRequestFullscreen();if(n.msRequestFullscreen)return n.msRequestFullscreen();console.warn("Fullscreen API is not supported")},async exitFullscreen(){document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.msExitFullscreen&&await document.msExitFullscreen()},handleFullscreenChange(){document.fullscreenElement||(this.isZoomed={original:!1,processed:!1})}}},Oe={class:"video-comparator"},Me={class:"global-controls"},Re={class:"comparison-container"},We={class:"video-wrapper"},Xe={class:"video-frame"},Ye=["src"],Ge={class:"video-wrapper"},Je={class:"video-frame"},Ke=["src"];function Qe(n,e,i,F,d,t){const y=ce("video-controls");return g(),b("div",Oe,[o("div",Me,[e[13]||(e[13]=o("h2",null,"视频分析（原视频 / 处理视频）",-1)),o("button",{class:"sync-button",onClick:e[0]||(e[0]=(...r)=>t.toggleSync&&t.toggleSync(...r))},k(d.isSyncing?"断开同步":"同步播放"),1)]),o("div",Re,[o("div",{class:G(["video-panel",{"fullscreen-mode":d.isZoomed.original}]),ref:"originalPanel"},[o("div",We,[o("div",Xe,[o("video",{ref:"originalVideo",src:i.originalSrc,onPlay:e[1]||(e[1]=r=>t.handlePlay("original")),onPause:e[2]||(e[2]=r=>t.handlePause("original")),onTimeupdate:e[3]||(e[3]=r=>t.updateProgress(r,"original"))},null,40,Ye)]),R(y,{type:"original",progress:d.progress.original,currentTime:d.currentTime.original,duration:d.duration.original,"is-zoomed":d.isZoomed.original,onTogglePlay:e[4]||(e[4]=r=>t.togglePlay("original")),onSeek:e[5]||(e[5]=r=>t.handleSeek(r,"original")),onToggleZoom:e[6]||(e[6]=r=>t.toggleZoom("original"))},null,8,["progress","currentTime","duration","is-zoomed"])])],2),o("div",{class:G(["video-panel",{"fullscreen-mode":d.isZoomed.processed}]),ref:"processedPanel"},[o("div",Ge,[o("div",Je,[o("video",{ref:"processedVideo",src:i.processedSrc,onPlay:e[7]||(e[7]=r=>t.handlePlay("processed")),onPause:e[8]||(e[8]=r=>t.handlePause("processed")),onTimeupdate:e[9]||(e[9]=r=>t.updateProgress(r,"processed"))},null,40,Ke)]),R(y,{type:"processed",progress:d.progress.processed,currentTime:d.currentTime.processed,duration:d.duration.processed,"is-zoomed":d.isZoomed.processed,onTogglePlay:e[10]||(e[10]=r=>t.togglePlay("processed")),onSeek:e[11]||(e[11]=r=>t.handleSeek(r,"processed")),onToggleZoom:e[12]||(e[12]=r=>t.toggleZoom("processed"))},null,8,["progress","currentTime","duration","is-zoomed"])])],2)])])}const es=W(He,[["render",Qe],["__scopeId","data-v-d26020d3"]]),ss={class:"analysis-container"},os={class:"section-title"},ts={class:"content-wrapper"},ns={key:0,class:"loading"},as={key:1,class:"error"},rs={__name:"Analysis",setup(n){const e=pe(),i=K(),F=u(""),d=u(""),t=u(!1),y=u(null),r=u(null),f=L(()=>e.historyItems.find(c=>c.id===e.currentAnalysisId)),O=L(()=>f.value?new Date(f.value.time).toLocaleString():""),M=async c=>{var h,x;try{t.value=!0;const V=i.token,C=await me.get(`/api/video/${c}`,{headers:{Authorization:`Bearer ${V}`}});C.data.success&&(F.value=C.data.data.original,d.value=C.data.data.processed||"")}catch(V){y.value=((x=(h=V.response)==null?void 0:h.data)==null?void 0:x.message)||"获取视频地址失败"}finally{t.value=!1}};return q(()=>{var c;return(c=f.value)==null?void 0:c.video_id},c=>{c&&M(c)},{immediate:!0}),q(()=>e.currentAnalysisId,c=>{const h=e.historyItems.find(x=>x.id===c);r.value=(h==null?void 0:h.video_id)||null},{immediate:!0}),q(r,c=>{c&&M(c)}),(c,h)=>{var x;return g(),b("div",ss,[o("h2",os,"分析汇总界面 - "+k(O.value),1),o("div",ts,[t.value?(g(),b("div",ns,"加载中...")):Z("",!0),y.value?(g(),b("div",as,k(y.value),1)):Z("",!0),R(es,{"original-src":F.value,"processed-src":d.value},null,8,["original-src","processed-src"]),(x=f.value)!=null&&x.video_id&&!t.value?(g(),ve(Ce,{key:2,"video-id":f.value.video_id},null,8,["video-id"])):Z("",!0),R(ze)])])}}},cs=W(rs,[["__scopeId","data-v-5fe9e054"]]);export{cs as default};
